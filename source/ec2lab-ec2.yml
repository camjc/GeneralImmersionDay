AWSTemplateFormatVersion: 2010-09-09
Resources:
  Ec2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.medium
      ImageId: ami-0fb8890c7a7ca1457
      UserData:
        'Fn::Base64':
          !Sub |
            <powershell>
            Import-Module ServerManager;
            Install-WindowsFeature Web-Server -IncludeManagementTools -IncludeAllSubFeature
            remove-item -recurse c:\inetpub\wwwroot\*
            (New-Object System.Net.WebClient).DownloadFile("https://immersionday-labs.s3.amazonaws.com/ec2-windows.zip", "c:\inetpub\wwwroot\ec2-windows.zip")

            $shell = new-object -com shell.application
            $zip = $shell.NameSpace("c:\inetpub\wwwroot\ec2-windows.zip")
            foreach($item in $zip.items())
            {
              $shell.Namespace("c:\inetpub\wwwroot\").copyhere($item)
            }
            Start-Process "iisreset.exe" -NoNewWindow -Wait

            Import-Module NetSecurity;
            Set-NetFirewallRule -DisplayName "File and Printer Sharing (Echo Request - ICMPv4-In)" -enabled True
            </powershell>
      Tags:
        - Key: Name
          Value: My EC2 Instance
      SecurityGroupIds:
        - sg-0dce1cbd2b76f0c59
      SubnetId: subnet-092cd96fbbbad61bb
  EIpAddress:
    Type: AWS::EC2::EIP
  EIpAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId: !Ref 'Ec2Instance'
      EIP: !Ref 'EIpAddress'
Outputs:
  InstanceId:
    Description: InstanceID of the new EC2 Instance.
    Value: !Ref 'Ec2Instance'
  InstanceIpAddress:
    Description: Public IP Address of the EC2 Instance.
    Value: !Ref 'EIpAddress'